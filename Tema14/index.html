<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejemplos de almacenamiento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" >
</head>
<body>

    <div class="container mt-5">
        <h1 class="mb-4">Ejemplos de Almacenamiento Web</h1>
        <div id="nunClics">0</div>
        <button id="btnClic" class="btn btn-primary mt-3">Haz clic aquí</button>
    </div>
    


    <script>

        window.addEventListener('load', async () => {

            //Compruebo si el navegador soporta Web Storage
            let webStorageSoportado = false;
            if (typeof(Storage) !== "undefined") {
                console.log("Web Storage soportado");
                webStorageSoportado = true;
            } else {
                console.log("Web Storage no soportado");
            }

            if (webStorageSoportado) {
                // Almacenamiento en localStorage
                localStorage.setItem('nombre', 'Juan Pérez');

                // Recuperación del dato almacenado
                const nombre = localStorage.getItem('nombre');
                console.log('Nombre desde localStorage:', nombre);

                // Contador de clics
                let contadorClics = 0;
                const btnClic = document.getElementById('btnClic');
                const nunClics = document.getElementById('nunClics');
                btnClic.addEventListener('click', () => {
                    contadorClics++;
                    nunClics.textContent = contadorClics;

                    // Almacenar el contador en localStorage
                    localStorage.setItem('contadorClics', contadorClics);
                });

                // Recuperar el contador almacenado al cargar la página
                const contadorAlmacenado = localStorage.getItem('contadorClics');
                if (contadorAlmacenado) {
                    contadorClics = parseInt(contadorAlmacenado, 10);
                    nunClics.textContent = contadorClics;
                }

                window.addEventListener('storage', (event) => {
                    if (event.key === 'contadorClics') {
                        contadorAlmacenadoNuevo = event.newValue;
                        contadorClics = parseInt(contadorAlmacenadoNuevo, 10);
                        nunClics.textContent = contadorClics;
                    }
                });


                // Almacenamiento en sessionStorage
                sessionStorage.setItem('sesionActiva', 'true');
                const sesionActiva = sessionStorage.getItem('sesionActiva');
                console.log('Sesión activa desde sessionStorage:', sesionActiva);

                
                // Abrir o crear la base de datos IndexedDB
                const db = await abrirBaseDatos();
                // Agregar un registro de clic a la base de datos cada vez que se haga clic en el botón
                btnClic.addEventListener('click', async () => {
                    await agregarClic(db, contadorClics);
                });

            }  

           
        });

        // Función para abrir/crear una base de datos IndexedDB. Con una tabla que tenga un campo para el contador de clics y otro para la fecha del clic.        
        /**
         * Abre (o crea si no existe) una base de datos IndexedDB llamada 'MiBaseDatos'.
         * Dentro de la base de datos, crea un almacén de objetos (tabla) llamado 'Clics',
         * que guarda cada clic con un contador y la fecha en que se hizo.
         *
         * @returns {Promise<IDBDatabase>} Promesa que se resuelve con la base de datos abierta.
         */
        function abrirBaseDatos() {
            return new Promise((resolve, reject) => {
                // Abrimos (o creamos) la base de datos 'MiBaseDatos' con versión 1
                const request = indexedDB.open('MiBaseDatos', 1);

                // Si ocurre un error al abrir la base de datos
                request.onerror = (event) => {
                    console.error('Error al abrir la base de datos:', event.target.errorCode);
                    reject(event.target.errorCode);
                };

                // Si la base de datos se abre correctamente
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    console.log('Base de datos abierta con éxito');
                    resolve(db); // Resolvemos la promesa con la base de datos
                };

                // Si es la primera vez o hay un cambio de versión, se crea la estructura
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    // Creamos la "tabla" Clics con clave primaria autoincremental 'id'
                    const objectStore = db.createObjectStore('Clics', { keyPath: 'id', autoIncrement: true });                   
                    console.log('Base de datos creada/actualizada con éxito');
                };
            });
        }

        /**
         * Agrega un nuevo registro de clic a la base de datos IndexedDB.
         * Cada vez que el usuario hace clic, se guarda el valor del contador y la fecha del clic.
         *
         * @param {IDBDatabase} db - La base de datos abierta donde se va a guardar el clic.
         * @param {number} contador - El número de clics actual.
         * @returns {Promise<void>} Promesa que se resuelve cuando el clic se ha guardado.
         */
        async function agregarClic(db, contador) {
            return new Promise((resolve, reject) => {
                // Iniciamos una transacción de escritura sobre la tabla 'Clics'
                const transaction = db.transaction(['Clics'], 'readwrite');
                const objectStore = transaction.objectStore('Clics');
                // Creamos el objeto que vamos a guardar: contador y fecha actual
                const fechaActual = new Date();
                const nuevoClic = { contador: contador, fecha: fechaActual };

                // Añadimos el nuevo clic a la base de datos
                const request = objectStore.add(nuevoClic);

                // Si se guarda correctamente
                request.onsuccess = () => {
                    console.log('Clic agregado a la base de datos:', nuevoClic);
                    resolve();
                };

                // Si ocurre un error al guardar
                request.onerror = (event) => {
                    console.error('Error al agregar el clic:', event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }



    </script>
    
</body>
</html>